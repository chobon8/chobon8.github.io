<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>基于任务异步编程模式（TAP） | 二博</title><meta name="author" content="二博"><meta name="copyright" content="二博"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言TAP是基于Task的异步编程设计模式, 异步编程 async : async关键字修饰的方法都会被视为异步方法，编译器会为方法生成一个对应的状态机 await : await关键字后面代表可等待方法，编译器会转化成TaskAwait去处理异步   async修饰符代表了这个方法是异步方法，编译器会生成状态机。  12345678910&#x2F;&#x2F;public async Task MethodAsy">
<meta property="og:type" content="article">
<meta property="og:title" content="基于任务异步编程模式（TAP）">
<meta property="og:url" content="https://blog.chobon.top/posts/32e0f934/index.html">
<meta property="og:site_name" content="二博">
<meta property="og:description" content="前言TAP是基于Task的异步编程设计模式, 异步编程 async : async关键字修饰的方法都会被视为异步方法，编译器会为方法生成一个对应的状态机 await : await关键字后面代表可等待方法，编译器会转化成TaskAwait去处理异步   async修饰符代表了这个方法是异步方法，编译器会生成状态机。  12345678910&#x2F;&#x2F;public async Task MethodAsy">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.chobon.top/blog/cover/wallpaper-3032044.jpg">
<meta property="article:published_time" content="2021-09-08T09:23:46.000Z">
<meta property="article:modified_time" content="2025-10-05T13:49:10.353Z">
<meta property="article:author" content="二博">
<meta property="article:tag" content=".NET">
<meta property="article:tag" content="异步编程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.chobon.top/blog/cover/wallpaper-3032044.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "基于任务异步编程模式（TAP）",
  "url": "https://blog.chobon.top/posts/32e0f934/",
  "image": "https://img.chobon.top/blog/cover/wallpaper-3032044.jpg",
  "datePublished": "2021-09-08T09:23:46.000Z",
  "dateModified": "2025-10-05T13:49:10.353Z",
  "author": [
    {
      "@type": "Person",
      "name": "二博",
      "url": "https://blog.chobon.top/"
    }
  ]
}</script><link rel="shortcut icon" href="https://img.chobon.top/blog/img/favicon.ico"><link rel="canonical" href="https://blog.chobon.top/posts/32e0f934/index.html"><link rel="preconnect" href="https://cdn.staticfile.org"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.7.2/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'true',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.staticfile.org/egjs-infinitegrid/4.12.0/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基于任务异步编程模式（TAP）',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><style type="text/css">.card-announcement .social-button{margin:.6rem 0 0 0;text-align:center}.card-announcement .social-button a{display:block;background-color:var(--btn-bg);color:var(--btn-color);text-align:center;line-height:2.4;margin:4px 0}.card-announcement .social-button a:hover{background-color:var(--btn-hover-color)}</style><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="二博" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">75</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 豆瓣</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://img.chobon.top/blog/cover/wallpaper-3032044.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">二博</span></a><a class="nav-page-title" href="/"><span class="site-name">基于任务异步编程模式（TAP）</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heart"></i><span> 豆瓣</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-film"></i><span> 电影</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书单</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 更多</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 相册</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">基于任务异步编程模式（TAP）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-09-08T09:23:46.000Z" title="发表于 2021-09-08 17:23:46">2021-09-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-05T13:49:10.353Z" title="更新于 2025-10-05 21:49:10">2025-10-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/NET/">.NET</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/NET/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">异步编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">389</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>1分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>TAP是基于Task的异步编程设计模式,</p>
<h2 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h2><ul>
<li><strong>async</strong> : async关键字修饰的方法都会被视为异步方法，编译器会为方法生成一个对应的状态机</li>
<li><strong>await</strong> : await关键字后面代表可等待方法，编译器会转化成TaskAwait去处理异步</li>
</ul>
<blockquote>
<p>async修饰符代表了这个方法是异步方法，编译器会生成状态机。</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">MethodAsync</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//do some thing</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//可等待方法，clr会挂起，等异步方法执行完才会执行剩下的逻辑</span></span><br><span class="line">    <span class="keyword">await</span> Method1Async();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//do some thing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="异步取消"><a href="#异步取消" class="headerlink" title="异步取消"></a>异步取消</h3><blockquote>
<p>采用CancellationToken来管理整个取消逻辑</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CancellationTokenSource source = <span class="keyword">new</span> CancellationTokenSource();</span><br><span class="line">CancellationToken token = source.Token;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">var</span> result <span class="keyword">await</span> <span class="title">MethodAsync</span>(<span class="params">token</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//外部取消</span></span><br><span class="line">source.Cancel();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">MethodAsync</span>(<span class="params">CancellationToken token</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//内部取消</span></span><br><span class="line">    source.Cancel();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="TAP转换APM"><a href="#TAP转换APM" class="headerlink" title="TAP转换APM"></a>TAP转换APM</h2><blockquote>
<p>采用TaskCompletionSource</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">ReadTask</span>(<span class="params"><span class="keyword">this</span> Stream stream, <span class="built_in">byte</span>[] buffer, <span class="built_in">int</span> offset, <span class="built_in">int</span> count, <span class="built_in">object</span> state</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> tcs = <span class="keyword">new</span> TaskCompletionSource&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    stream.BeginRead(buffer, offset, count, ar =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> </span><br><span class="line">        &#123; </span><br><span class="line">            tcs.SetResult(stream.EndRead(ar)); </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception exc) </span><br><span class="line">        &#123; </span><br><span class="line">            tcs.SetException(exc); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, state);</span><br><span class="line">    <span class="keyword">return</span> tcs.Task;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>官方封装了工具类TaskToApm</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Task转APM密封类</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">TaskAsyncResult</span>:<span class="title">IAsyncResult</span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Task转成APM对应的Begin方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IAsyncResult <span class="title">Begin</span>(<span class="params">Task task, AsyncCallback? callback, <span class="built_in">object</span>? state</span>)</span> =&gt;</span><br><span class="line">            <span class="keyword">new</span> TaskAsyncResult(task, state, callback);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TResult <span class="title">End</span>&lt;<span class="title">TResult</span>&gt;(<span class="params">IAsyncResult asyncResult</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (GetTask(asyncResult) <span class="keyword">is</span> Task&lt;TResult&gt; task)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> task.GetAwaiter().GetResult();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ThrowArgumentException(asyncResult);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">default</span>!; <span class="comment">// unreachable</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//转换后的Begin方法使用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">BeginMethod</span>(<span class="params">AsyncCallback callback,<span class="built_in">object</span>? </span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    TaskToApm.Begin(MethodAsync(),callback,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>TAP已经让异步编程无感了，就像正常的方法一样，不用再关心如何去处理结果。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.chobon.top">二博</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.chobon.top/posts/32e0f934/">https://blog.chobon.top/posts/32e0f934/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.chobon.top" target="_blank">二博</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/NET/">.NET</a><a class="post-meta__tags" href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/">异步编程</a></div><div class="post-share"><div class="social-share" data-image="https://img.chobon.top/blog/cover/wallpaper-3032044.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.staticfile.org/butterfly-extsrc/1.1.4/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.staticfile.org/butterfly-extsrc/1.1.4/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://img.chobon.top/blog/img/wechat.png" target="_blank"><img class="post-qr-code-img" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.chobon.top/blog/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/f25b3530/" title="基于事件异步编程模式（EAP）"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-125399.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">基于事件异步编程模式（EAP）</div></div><div class="info-2"><div class="info-item-1">前言EAP，全称Event-based Asynchronous...</div></div></div></a><a class="pagination-related" href="/posts/d8b3a72c/" title="Task的底层实现"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-200244.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Task的底层实现</div></div><div class="info-2"><div class="info-item-1">async关键字我们将async修饰的方法叫做“异步方法”，但是并不意味着方法是异步执行，也不意味着该方法是异步方法。  源码  12345static async Task MethodAsync()&#123;    await Task.Run(()=&gt;Console.WriteLine(&quot;asynchronous run&quot;));    Console.WriteLine(&quot;synchronous run&quot;);&#125;   反编译代码  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374private sealed class &lt;MethodAsync&gt;d__1 : IAsyncStateMachine&#123;    public int &lt;&gt;1__state;   ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/d8b3a72c/" title="Task的底层实现"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-200244.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-09</div><div class="info-item-2">Task的底层实现</div></div><div class="info-2"><div class="info-item-1">async关键字我们将async修饰的方法叫做“异步方法”，但是并不意味着方法是异步执行，也不意味着该方法是异步方法。  源码  12345static async Task MethodAsync()&#123;    await Task.Run(()=&gt;Console.WriteLine(&quot;asynchronous run&quot;));    Console.WriteLine(&quot;synchronous run&quot;);&#125;   反编译代码  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374private sealed class &lt;MethodAsync&gt;d__1 : IAsyncStateMachine&#123;    public int &lt;&gt;1__state;   ...</div></div></div></a><a class="pagination-related" href="/posts/f25b3530/" title="基于事件异步编程模式（EAP）"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-125399.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-09-07</div><div class="info-item-2">基于事件异步编程模式（EAP）</div></div><div class="info-2"><div class="info-item-1">前言EAP，全称Event-based Asynchronous...</div></div></div></a><a class="pagination-related" href="/posts/c5a30916/" title="异步编程模型（APM）"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-200244.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-25</div><div class="info-item-2">异步编程模型（APM）</div></div><div class="info-2"><div class="info-item-1">前言最近改了个老项目，当初异步是用APM写的，于是重温了下APM 你知道APM吗APM即异步编程模型的简写（Asynchronous Programming Model），写代码的时候或者查看.NET的类库的时候肯定会经常看到和使用以BeginXXX和EndXXX类似的方法，其实你在使用这些方法的时候，你就再使用异步编程模型来编写程序。对于给定XXX同步操作，异步版本的就是BeginXXX和EndXXX，BeginXXX启动操作，EdnXXX获取操作结果，此时如果操作未完成，则阻塞线程等待，变成同步方法。 异步模型从.NET1.0开始就支持的异步编程模型，整个过程是围绕IAsyncResult对象进行的，异步操作通过Begin操作和End操作这两个方法实现。 IAsyncResult对象存储有关异步操作的信息。 12345678910111213141516171819public interface IAsyncResult&#123;    bool IsCompleted    &#123;        get;    &#125;    WaitHandle...</div></div></div></a><a class="pagination-related" href="/posts/226186c6/" title="ASP.NET Core MVC 5.x初始化源码解读（一）"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-200244.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="info-item-2">ASP.NET Core MVC 5.x初始化源码解读（一）</div></div><div class="info-2"><div class="info-item-1">前言初始化比较复杂，文章拆分成3部分Host、WebHost、Startup，逐一分析 对象概念解释 接口定义   IHost : 主机抽象  IServiceProvider : 对象服务提供器 StartAsync : 启动方法 StopAsync : 停止方法   IHostBuilder : 主机构造器抽象  ConfigureHostConfiguration() : 配置主机配置文件 ConfigureAppConfiguration() : 配置应用配置文件 ConfigureServices() : 配置服务 UseServiceProviderFactory() : 配置服务提供商工厂 ConfigureContainer() : 配置容器 Build() : 构造主机     具体实现   Host : 主机  IHostLifetime : 主机生命周期 IServiceProvider : 服务提供商 ApplicationLifetime : 应用生命周期 HostOptions :...</div></div></div></a><a class="pagination-related" href="/posts/329c39bd/" title="ASP.NET Core MVC 5.x初始化源码解读（二）"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-48960.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="info-item-2">ASP.NET Core MVC 5.x初始化源码解读（二）</div></div><div class="info-2"><div class="info-item-1">WebHost对象概念解释WebHost  接口定义   IWebHost : 主机抽象  IFeatureCollection : 插件容器 IServiceProvider : 对象服务提供器 Start : 启动方法（同步） StartAsync : 启动方法 StopAsync : 停止方法   IWebHostBuilder : 网站主机构建器  Build : 构建 ConfigureAppConfiguration : 配置应用配置文件 ConfigureServices : 配置服务 GetSetting : 读取单个配置值 UseSetting : 设置单个配置项     具体实现   GenericWebHostBuilder : 通用网站主机构造器（HostBuilder桥接器）  ConfigureHostConfiguration : 设置主机配置 ConfigureAppConfiguration : 设置应用配置 ConfigureServices : 设置服务 UseStartup :...</div></div></div></a><a class="pagination-related" href="/posts/c29cb869/" title="ASP.NET Core MVC 源码解读-应用程序模型"><img class="cover" src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-48960.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-16</div><div class="info-item-2">ASP.NET Core MVC 源码解读-应用程序模型</div></div><div class="info-2"><div class="info-item-1">概念ASP.NET Core MVC 会定义一个 应用程序模型，用于表示 MVC 应用的各个组件。 读取并处理此模型，以修改 MVC 元素的行为方式。 默认情况下，MVC 遵循特定的约定来确定哪些类被视为控制器、这些类上的哪些方法是操作以及参数和路由的行为方式。 自定义此行为以满足应用程序的需求，方法是创建自定义约定，并将其作为全局或特性应用。 模型(Model)和程序提供器(Provider) 对象模型(Model)  ASP.NET Core MVC 应用程序模型包括用于描述 MVC 应用程序的抽象接口和具体实现类。 此模型是 MVC 根据默认约定发现应用的控制器、操作、操作参数、路由和筛选器的结果。 通过使用应用程序模型，修改应用以遵循默认 MVC 行为中的不同约定。 参数、名称、路由和筛选器都用作操作和控制器的配置数据。ASP.NET Core MVC 应用程序模型具有以下结构：  ApplicationModel 控制器 (ControllerModel) 属性 (PropertyModel)   操作 (ActionModel) 参数...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">二博</div><div class="author-info-description">生活不止有工作</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">75</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/chobon8"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/chobon8" target="_blank" title="Github"><i class="fa-brands fa-github"></i></a><a class="social-icon" href="mailto:chobon@aliyun.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">异步编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%8F%96%E6%B6%88"><span class="toc-number">2.1.</span> <span class="toc-text">异步取消</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TAP%E8%BD%AC%E6%8D%A2APM"><span class="toc-number">3.</span> <span class="toc-text">TAP转换APM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">小结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/705c9884/" title="Linux磁盘坏道检测和修复"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-125399.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux磁盘坏道检测和修复"/></a><div class="content"><a class="title" href="/posts/705c9884/" title="Linux磁盘坏道检测和修复">Linux磁盘坏道检测和修复</a><time datetime="2025-10-05T12:46:58.000Z" title="发表于 2025-10-05 20:46:58">2025-10-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/dfeb25f1/" title="Proxmox上LXC磁盘缩小"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-48960.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Proxmox上LXC磁盘缩小"/></a><div class="content"><a class="title" href="/posts/dfeb25f1/" title="Proxmox上LXC磁盘缩小">Proxmox上LXC磁盘缩小</a><time datetime="2024-05-15T11:46:58.000Z" title="发表于 2024-05-15 19:46:58">2024-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/a594add/" title="RKE搭建Kubernetes集群环境"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-200244.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RKE搭建Kubernetes集群环境"/></a><div class="content"><a class="title" href="/posts/a594add/" title="RKE搭建Kubernetes集群环境">RKE搭建Kubernetes集群环境</a><time datetime="2022-03-08T14:22:08.000Z" title="发表于 2022-03-08 22:22:08">2022-03-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/bc681fc7/" title="Ubuntu安装Docker"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/Docker_Logo.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ubuntu安装Docker"/></a><div class="content"><a class="title" href="/posts/bc681fc7/" title="Ubuntu安装Docker">Ubuntu安装Docker</a><time datetime="2021-12-02T15:07:41.000Z" title="发表于 2021-12-02 23:07:41">2021-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/da975915/" title="V2ray更新gRPC"><img src= "https://img.chobon.top/blog/img/loading.gif" data-lazy-src="https://img.chobon.top/blog/cover/wallpaper-3032044.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V2ray更新gRPC"/></a><div class="content"><a class="title" href="/posts/da975915/" title="V2ray更新gRPC">V2ray更新gRPC</a><time datetime="2021-11-30T10:15:45.000Z" title="发表于 2021-11-30 18:15:45">2021-11-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By 二博</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.3</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/"></script><script src="https://cdn.staticfile.org/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.staticfile.org/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><div class="js-pjax"><script>(async () => {
  const showKatex = () => {
    document.querySelectorAll('#article-container .katex').forEach(el => el.classList.add('katex-show'))
  }

  if (!window.katex_js_css) {
    window.katex_js_css = true
    await btf.getCSS('https://cdn.staticfile.org/KaTeX/0.16.21/katex.min.css')
    if (false) {
      await btf.getScript('https://cdn.staticfile.org/KaTeX/0.16.21/contrib/copy-tex.min.js')
    }
  }

  showKatex()
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.staticfile.org/mermaid/11.4.1/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"data-mapping":"pathname","data-strict":1,"data-reactions-enabled":1,"data-emit-metadata":1,"data-input-position":"top","data-lang":"zh-CN","data-loading":"lazy","crossorigin":"anonymous"}

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'chobon8/chobon8.github.io',
      'data-repo-id': 'MDEwOlJlcG9zaXRvcnkyMTk3ODU1Njk=',
      'data-category-id': 'DIC_kwDODRmpYc4CR2Ca',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !true) {
    if (true) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><div class="aplayer no-destroy" data-id="2201879658" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"></div><link rel="stylesheet" href="https://cdn.staticfile.org/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.staticfile.org/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn.staticfile.org/butterfly-extsrc/1.1.4/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.staticfile.org/pjax/0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:description\"]","link[rel=\"canonical\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>